<main class="container">
  <h4 class="mb-3">주문</h4>
  <hr class="my-4" />
  <form id="form-checkout" novalidate>
    <h5 class="mb-3">구매자</h5>
    <div class="mb-3 row">
      <label for="staticName" class="col-12 col-form-label">이름</label>
      <div class="col-sm-10">
        <input
          type="text"
          readonly
          class="form-control-plaintext form-control-sm"
          id="staticName"
          value="-"
        />
      </div>
    </div>
    <div class="mb-3 row">
      <label for="staticEmail" class="col-12 col-form-label"
        >이메일</label
      >
      <div class="col-sm-10">
        <input
          type="text"
          readonly
          class="form-control-plaintext form-control-sm"
          id="staticEmail"
          value="-"
        />
      </div>
    </div>

    <hr class="my-4" />

    <h5 class="mb-3">받는 사람</h5>
    <div class="mb-3 col-12">
      <label for="contactName" class="form-label">이름</label>
      <input
        type="text"
        class="form-control"
        id="contactName"
        name="contactName"
        placeholder="받는 사람"
        required
      />
    </div>
    <div class="mb-3 col-12">
      <label for="contactPhone" class="form-label"
        >연락 가능한 핸드폰</label
      >
      <input
        type="text"
        class="form-control"
        id="contactPhone"
        name="contactPhone"
        placeholder="받는 사람 핸드폰"
        required
      />
    </div>
    <div class="mb-3 col-12">
      <label for="contactAddress" class="form-label">받을 주소</label>
      <input
        type="text"
        class="form-control"
        id="contactAddress"
        name="contactAddress"
        placeholder="OO시 OO구 OO동 상세주소까지 자세히 적어주세요."
        required
      />
    </div>
    <div class="mb-3 col-12">
      <label for="memo" class="form-label">요청사항</label>
      <textarea class="form-control" id="memo" rows="3" onclick="this.value=''">맛있게 해주세요</textarea>
    </div>

    <hr class="my-4" />
    <div class="mb-3 col-12">
      <h5 class="mb-3">결제 금액</h5>
      <p><strong id="totalPrice"> - </strong>원</p>
      <div id="menu-list"></div>
    </div>

    <hr class="my-4" />

    <button class="w-100 btn btn-dark btn-lg" type="submit">주문</button>
  </form>
</main>


<script>
  $(document).ready(function(){
    const menuId = window.location.pathname.replace(/\/checkout\/?/,'');

    if(menuId){
      //즉시 주문했을 때 주문페이지
      $.ajax({
        type : 'GET',
        url : `/api/order/${menuId}`,
        headers: {
            'Authorization': `Bearer ${tokens.accessToken}`,
            'Refresh': `${tokens.refreshToken}`
        },
        success: function(response){
          const { 
            user: {
              userName,
              email,
              phone,
              address
            },
            menu: {
              menuName,
              menuPrice,
            } 
          } =response.preOrderInfo
          $('#staticName').val(userName)
          $('#staticEmail').val(email)
          $('#contactName').val(userName)
          $('#contactPhone').val(phone)
          $('#contactAddress').val(address)

          const menuHTML = `
            <span class="badge rounded-pill text-bg-dark">${menuName}</span>
          `
          $('#menu-list').append(menuHTML)
          $('#totalPrice').text(menuPrice)

        },
        error: function(err){
          alert(err.responseJSON.message)
        },
      })
        
      $('#form-checkout').submit(e => handleFormSubmit(e, menuId))
    } else {
      //장바구니에서 주문했을 때 주문페이지
      const {
        userName, 
        email, 
        phone, 
        address, 
        total, 
        menus
      } = JSON.parse(sessionStorage.getItem("cart"))
      
      const menuHTML = menus.map( menu => `<span class="badge rounded-pill text-bg-dark me-1">${menu}</span>`).join('')
      $('#menu-list').append(menuHTML)

      $('#staticName').val(userName)
      $('#staticEmail').val(email)
      $('#contactName').val(userName)
      $('#contactPhone').val(phone)
      $('#contactAddress').val(address)
      $('#totalPrice').text(total)

      $('#form-checkout').submit(e => handleFormSubmit(e, null))
    }
  })
  
  function handleFormSubmit(e, menuId){
    e.preventDefault();

    const contactName = $('#contactName').val()
    const contactPhone = $('#contactPhone').val()
    const contactAddress = $('#contactAddress').val()
    const memo = $('#memo').val()
        
    $.ajax({
      type : 'POST',
      url : menuId ? `/api/order/${menuId}` : '/api/order',
      headers: {
        'Authorization': `Bearer ${tokens.accessToken}`,
        'Refresh': `${tokens.refreshToken}`
      },
      data: {
        contactName,
        contactPhone,
        contactAddress,
        memo
      },
      success: function(response){
        alert(response.message)
        sessionStorage.removeItem("cart")
        window.location.href="/orders"
      },
      error: function(err){
        alert(err.responseJSON.message)
      },
    })
  }

</script>